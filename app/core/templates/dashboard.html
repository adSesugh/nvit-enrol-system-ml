{% extends 'base.html' %}

{% block title %} Dashboard {% endblock %}

{% block content %}
    <div class="row">
        <div class="col-sm-12 mb-4 mb-xl-0">
            <h4 class="font-weight-bold text-dark">Hi, welcome back!</h4>
            <p class="font-weight-normal mb-2 text-muted">{{ current_user.full_name }}</p>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-xl-5 flex-column d-flex grid-margin">
            <div class="row grid-margin">
                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Applications</h4>
                            <h4 class="text-dark font-weight-bold mb-2">1615</h4>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">WB Expected</h4>
                            <h4 class="text-dark font-weight-bold mb-2">860</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row grid-margin">
                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Admitted</h4>
                            <h4 class="text-dark font-weight-bold mb-2">{{ records.captured }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Available Courses</h4>
                            <h4 class="text-dark font-weight-bold mb-2">6</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row grid-margin">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Online Application Distribution</h2>
                            <table class="table d-lg-table">
                                <tr>
                                    <th></th>
                                    <th>Female</th>
                                    <th>Male</th>
                                </tr>
                                <tr>
                                    <th>PWD</th>
                                    <td>123</td>
                                    <td>12</td>
                                </tr>
                                <tr>
                                    <th>Normal</th>
                                    <td>123</td>
                                    <td>12</td>
                                </tr>
                                <tr>
                                    <th>Total</th>
                                    <th>123</th>
                                    <th>12</th>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Online Application Employment Status</h2>
                            <table class="table d-lg-table">
                                <tr>
                                    <th></th>
                                    <th>Female</th>
                                    <th>Male</th>
                                </tr>
                                <tr>
                                    <td>Employed</td>
                                    <td>123</td>
                                    <td>12</td>
                                </tr>
                                <tr>
                                    <td>Unemployed</td>
                                    <td>123</td>
                                    <td>12</td>
                                </tr>
                                <tr>
                                    <td>Self Employed</td>
                                    <td>123</td>
                                    <td>12</td>
                                </tr>
                                <tr>
                                    <td>Others</td>
                                    <td>123</td>
                                    <td>12</td>
                                </tr>

                                <tr>
                                    <th>Total</th>
                                    <th>123</th>
                                    <th>12</th>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Online Application Age Distribution</h2>
                            <table class="table d-lg-table">
                                <tr>
                                    <th>Age Range</th>
                                    <th>Female</th>
                                    <th>Male</th>
                                </tr>
                                <tr>
                                    <td>15 - 24</td>
                                    <td>123</td>
                                    <td>12</td>
                                </tr>
                                <tr>
                                    <td>25 to 35</td>
                                    <td>123</td>
                                    <td>12</td>
                                </tr>
                                <tr>
                                    <td>36 Above</td>
                                    <td>123</td>
                                    <td>12</td>
                                </tr>
                                <tr>
                                    <th>Total</th>
                                    <th>123</th>
                                    <th>12</th>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Female Admitted</h4>
                            <table class="table d-lg-table">
                                <tr>
                                    <th>Status</th>
                                    <td align="center">Count</td>
                                </tr>
                                <tr>
                                    <th>PWD</th>
                                    <td align="center">{{ records.female_disabled }}</td>
                                </tr>
                                <tr>
                                    <th>Normal</th>
                                    <td align="center">{{ records.female_count - records.female_disabled }}</td>
                                </tr>
                                <tr>
                                    <th>Total</th>
                                    <td align="center"><b>{{ records.female_count }}</b></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Male Admitted</h4>
                            <table class="table d-lg-table">
                                <tr>
                                    <th>Status</th>
                                    <td align="center">Count</td>
                                </tr>
                                <tr>
                                    <th>PWD</th>
                                    <td align="center">{{ records.male_disabled }}</td>
                                </tr>
                                <tr>
                                    <th>Normal</th>
                                    <td align="center">{{ records.male_count - records.male_disabled }}</td>
                                </tr>
                                <tr>
                                    <th>Total</th>
                                    <td align="center"><b>{{ records.male_count }}</b></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-7 d-flex flex-column grid-margin stretch-card">
            <div class="row grid-margin">
                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Female Applicants</h4>
                            <table class="table d-lg-table">
                                <tr>
                                    <th>Status</th>
                                    <td align="center">Count</td>
                                </tr>
                                <tr>
                                    <th>PWD</th>
                                    <td align="center">{{ records.female_disabled }}</td>
                                </tr>
                                <tr>
                                    <th>Normal</th>
                                    <td align="center">{{ records.female_count - records.female_disabled }}</td>
                                </tr>
                                <tr>
                                    <th>Total</th>
                                    <td align="center"><b>{{ records.female_count }}</b></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Male Applicants</h4>
                            <table class="table d-lg-table">
                                <tr>
                                    <th>Status</th>
                                    <td align="center">Count</td>
                                </tr>
                                <tr>
                                    <th>PWD</th>
                                    <td align="center">{{ records.male_disabled }}</td>
                                </tr>
                                <tr>
                                    <th>Normal</th>
                                    <td align="center">{{ 1615 - records.female_count }}</td>
                                </tr>
                                <tr>
                                    <th>Total</th>
                                    <td align="center"><b>{{ records.male_disabled + (1615 - records.female_count) }}</b></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% if current_user.role == 'admin' %}
                <div class="card my-1 w-100">
                    <div class="card-body">
                        <h5 class="card-title">Applicants Employment Status</h5>
                        <table class="table table-striped">
                            <tr>
                                {% for status in employment_status %}
                                    <td>
                                        <div class="d-flex flex-column">
                                            <div class="my-1">
                                                <h5 class="card-title">{{ status[0] }}</h5>
                                            </div>
                                            <h6 class="card-text">{{ status[1] }}</h6>
                                        </div>
                                    </td>
                                {% endfor %}
                            </tr>
                        </table>
                    </div>
                </div>
            {% endif %}
            <div class="row grid-margin">
                <div class="col-12 d-flex justify-content-center align-content-center">
                    <div class="card w-100 p-4">
                        <h4 class="card-title">Disabled and non-disabled Distribution against courses</h4>
                        <canvas id="femaleMaleChart" height="250" class="mt-3"></canvas>
                    </div>
                </div>
            </div>
            <div class="card mb-3">
              <div class="card-body">
                    <h4 class="card-title">Applicant distribution against courses</h4>
                    <div class="row">
                        <div class="col-sm-12">
                            <canvas id="coursesChart" height="200" class="mt-3"></canvas>
                        </div>
                    </div>
                    <div class="row my-2">
                        <div class="card-header mt-2">
                            <h4 class="card-title mb-1">Code Description</h4>
                        </div>
                        <div class="row">
                            {% for (index, code) in enumerate(records.stats.labels) %}
                                <div class="col-12 my-1 card-text" style="font-size: 12px;">{{ code }} - {{ records.stats.courses[index] }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
              </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script>
        const ctx = document.getElementById('coursesChart');
        const ctx_disabled = document.getElementById('femaleMaleChart');
        var labels = {{ records.stats.labels|tojson }};
        var course_data = {{ records.stats.data|tojson }};

        new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Applicants per course',
                data: course_data,
                borderWidth: 1,
                minBarLength: 2,
              }]
            },
            options: {
                scales: {
                    y: {
                    beginAtZero: true,
                        grid: {
                            display: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                indexAxis: 'y',
                plugins: {
                    datalabels: {
                        formatter: function(value, context) {
                            return context.chart.data.labels[context.dataIndex];
                        }
                    }
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            var statsdata = {{ stats_data | tojson | safe }};

            console.log(statsdata)

            // Organize data into separate arrays for Chart.js
            var pwd_labels = Array.from(new Set(statsdata.map(item => item.course_of_study)));
            var disabledNoData = [];
            var disabledYesData = [];

            // Populate data arrays
            pwd_labels.forEach(function (label) {
                var disabledNoCount = statsdata.filter(item => item.course_of_study === label && item.disabled === 'no').reduce((acc, cur) => acc + cur.count, 0);
                var disabledYesCount = statsdata.filter(item => item.course_of_study === label && item.disabled === 'yes').reduce((acc, cur) => acc + cur.count, 0);

                disabledNoData.push(disabledNoCount ? disabledNoCount : null);
                disabledYesData.push(disabledYesCount ? disabledYesCount : null);
            });

            console.log(disabledNoData)

            var ctx = document.getElementById('femaleMaleChart').getContext('2d');
            var femaleMaleChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: pwd_labels,
                    datasets: [
                        { label: 'Disabled: No', data: disabledNoData, borderColor: 'blue', fill: false },
                        { label: 'Disabled: Yes', data: disabledYesData, borderColor: 'red', fill: false }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}